<!DOCTYPE html>  <html> <head>   <title>middleware.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="index.html">                 index.js               </a>                                           <a class="source" href="middleware.html">                 middleware.js               </a>                                           <a class="source" href="swagger.html">                 swagger.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               middleware.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>This is a Controller mixin for adding methods to manage middleware creation.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p><strong>Dependencies</strong></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">middleware</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../middleware&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p><strong>Private Module Members</strong></p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Handle variable number of arguments</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">last</span> <span class="p">(</span><span class="nx">skip</span><span class="p">,</span> <span class="nx">names</span><span class="p">,</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="kd">var</span> <span class="nx">position</span> <span class="o">=</span> <span class="nx">names</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">values</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">values</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="p">}).</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">skip</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">count</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Too few arguments.&#39;</span><span class="p">);</span>

  <span class="nx">names</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">skip</span> <span class="o">+</span> <span class="nx">count</span> <span class="o">-</span> <span class="nx">position</span><span class="p">;</span>
    <span class="nx">position</span><span class="o">--</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">&gt;=</span> <span class="nx">skip</span><span class="p">)</span> <span class="nx">r</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">values</span><span class="p">[</span><span class="nx">index</span><span class="p">];</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Parse middleware</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">factor</span> <span class="p">(</span><span class="nx">stage</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">stage</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Must supply stage.&#39;</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">factored</span> <span class="o">=</span> <span class="p">[];</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">verbs</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">verbs</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">verbs</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">verbs</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">verb</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="sr">/^head|get|put|post|del$/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">verb</span><span class="p">))</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Unrecognized verb: &#39;</span> <span class="o">+</span> <span class="nx">verb</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">howMany</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">howMany</span> <span class="o">!==</span> <span class="s1">&#39;instance&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">howMany</span> <span class="o">!==</span> <span class="s1">&#39;collection&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Unrecognized howMany: &#39;</span> <span class="o">+</span> <span class="nx">options</span><span class="p">.</span><span class="nx">howMany</span><span class="p">);</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Middleware function or array</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">middleware</span><span class="p">)</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">middleware</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">howMany</span> <span class="o">!==</span> <span class="s1">&#39;collection&#39;</span><span class="p">)</span> <span class="nx">factored</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="nx">stage</span><span class="o">:</span> <span class="nx">stage</span><span class="p">,</span> <span class="nx">howMany</span><span class="o">:</span> <span class="s1">&#39;instance&#39;</span><span class="p">,</span> <span class="nx">verbs</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">verbs</span><span class="p">,</span> <span class="nx">middleware</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">middleware</span> <span class="p">});</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">howMany</span> <span class="o">!==</span> <span class="s1">&#39;instance&#39;</span><span class="p">)</span> <span class="nx">factored</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="nx">stage</span><span class="o">:</span> <span class="nx">stage</span><span class="p">,</span> <span class="nx">howMany</span><span class="o">:</span> <span class="s1">&#39;collection&#39;</span><span class="p">,</span> <span class="nx">verbs</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">verbs</span><span class="p">,</span> <span class="nx">middleware</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">middleware</span> <span class="p">});</span>
    <span class="k">return</span> <span class="nx">factored</span><span class="p">;</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Middleware hash keyed on instance/collection, then verb</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">howMany</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Specified instance/collection twice.&#39;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">verbs</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Specified verbs twice.&#39;</span><span class="p">);</span>

  <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">middleware</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">howManyKey</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">middleware</span><span class="p">[</span><span class="nx">howManyKey</span><span class="p">]).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">verb</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">factored</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
        <span class="nx">stage</span><span class="o">:</span> <span class="nx">stage</span><span class="p">,</span>
        <span class="nx">howMany</span><span class="o">:</span> <span class="nx">howManyKey</span><span class="p">,</span>
        <span class="nx">verbs</span><span class="o">:</span> <span class="nx">verb</span><span class="p">,</span>
        <span class="nx">middleware</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">middleware</span><span class="p">[</span><span class="nx">howManyKey</span><span class="p">][</span><span class="nx">verb</span><span class="p">]</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="nx">factored</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p><strong>Module Definition</strong></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">mixin</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p><strong>Private Instance Members</strong></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">controller</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Flags whether the custom middleware has been activated</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">activated</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>A hash for storing user middleware</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">custom</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;request&quot;</span><span class="o">:</span>
    <span class="p">{</span> <span class="s2">&quot;instance&quot;</span><span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;head&quot;</span><span class="o">:</span> <span class="p">[],</span> <span class="s2">&quot;get&quot;</span><span class="o">:</span> <span class="p">[],</span> <span class="s2">&quot;post&quot;</span><span class="o">:</span> <span class="p">[],</span> <span class="s2">&quot;put&quot;</span><span class="o">:</span> <span class="p">[],</span> <span class="s2">&quot;del&quot;</span><span class="o">:</span> <span class="p">[]</span> <span class="p">},</span>
     <span class="s2">&quot;collection&quot;</span><span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;head&quot;</span><span class="o">:</span> <span class="p">[],</span> <span class="s2">&quot;get&quot;</span><span class="o">:</span> <span class="p">[],</span> <span class="s2">&quot;post&quot;</span><span class="o">:</span> <span class="p">[],</span> <span class="s2">&quot;put&quot;</span><span class="o">:</span> <span class="p">[],</span> <span class="s2">&quot;del&quot;</span><span class="o">:</span> <span class="p">[]</span> <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;query&quot;</span><span class="o">:</span>
    <span class="p">{</span> <span class="s2">&quot;instance&quot;</span><span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;head&quot;</span><span class="o">:</span> <span class="p">[],</span> <span class="s2">&quot;get&quot;</span><span class="o">:</span> <span class="p">[],</span> <span class="s2">&quot;post&quot;</span><span class="o">:</span> <span class="p">[],</span> <span class="s2">&quot;put&quot;</span><span class="o">:</span> <span class="p">[],</span> <span class="s2">&quot;del&quot;</span><span class="o">:</span> <span class="p">[]</span> <span class="p">},</span>
     <span class="s2">&quot;collection&quot;</span><span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;head&quot;</span><span class="o">:</span> <span class="p">[],</span> <span class="s2">&quot;get&quot;</span><span class="o">:</span> <span class="p">[],</span> <span class="s2">&quot;post&quot;</span><span class="o">:</span> <span class="p">[],</span> <span class="s2">&quot;put&quot;</span><span class="o">:</span> <span class="p">[],</span> <span class="s2">&quot;del&quot;</span><span class="o">:</span> <span class="p">[]</span> <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;documents&quot;</span><span class="o">:</span>
    <span class="p">{</span> <span class="s2">&quot;instance&quot;</span><span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;head&quot;</span><span class="o">:</span> <span class="p">[],</span> <span class="s2">&quot;get&quot;</span><span class="o">:</span> <span class="p">[],</span> <span class="s2">&quot;post&quot;</span><span class="o">:</span> <span class="p">[],</span> <span class="s2">&quot;put&quot;</span><span class="o">:</span> <span class="p">[],</span> <span class="s2">&quot;del&quot;</span><span class="o">:</span> <span class="p">[]</span> <span class="p">},</span>
     <span class="s2">&quot;collection&quot;</span><span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;head&quot;</span><span class="o">:</span> <span class="p">[],</span> <span class="s2">&quot;get&quot;</span><span class="o">:</span> <span class="p">[],</span> <span class="s2">&quot;post&quot;</span><span class="o">:</span> <span class="p">[],</span> <span class="s2">&quot;put&quot;</span><span class="o">:</span> <span class="p">[],</span> <span class="s2">&quot;del&quot;</span><span class="o">:</span> <span class="p">[]</span> <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>A method used to register user middleware to be activated during intialization.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">register</span> <span class="p">(</span><span class="nx">stage</span><span class="p">,</span> <span class="nx">howMany</span><span class="p">,</span> <span class="nx">verbs</span><span class="p">,</span> <span class="nx">middleware</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">activated</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t add middleware after the controller has been activated.&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">last</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;howMany&#39;</span><span class="p">,</span> <span class="s1">&#39;verbs&#39;</span><span class="p">,</span> <span class="s1">&#39;middleware&#39;</span><span class="p">],</span> <span class="nx">arguments</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Prevent explicitly setting query-stage POST middleware.  Implicitly adding
this middleware is ignored.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">stage</span> <span class="o">===</span> <span class="s1">&#39;query&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">verbs</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">verbs</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;post&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Query stage not executed for POST.&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">factor</span><span class="p">(</span><span class="nx">stage</span><span class="p">,</span> <span class="nx">options</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">definition</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">verbs</span> <span class="o">=</span> <span class="nx">definition</span><span class="p">.</span><span class="nx">verbs</span> <span class="o">||</span> <span class="s1">&#39;head get post put del&#39;</span><span class="p">;</span>
      <span class="nx">verbs</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">verb</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">verb</span><span class="p">)</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
        <span class="nx">custom</span><span class="p">[</span><span class="nx">definition</span><span class="p">.</span><span class="nx">stage</span><span class="p">][</span><span class="nx">definition</span><span class="p">.</span><span class="nx">howMany</span><span class="p">][</span><span class="nx">verb</span><span class="p">]</span> <span class="o">=</span> <span class="nx">custom</span><span class="p">[</span><span class="nx">definition</span><span class="p">.</span><span class="nx">stage</span><span class="p">][</span><span class="nx">definition</span><span class="p">.</span><span class="nx">howMany</span><span class="p">][</span><span class="nx">verb</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">definition</span><span class="p">.</span><span class="nx">middleware</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>A method used to activate user middleware that was previously registered.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">activate</span> <span class="p">(</span><span class="nx">stage</span><span class="p">,</span> <span class="nx">howMany</span><span class="p">,</span> <span class="nx">verbs</span><span class="p">,</span> <span class="nx">middleware</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">activated</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t activate middleware after the controller has been activated.&quot;</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">last</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;howMany&#39;</span><span class="p">,</span> <span class="s1">&#39;verbs&#39;</span><span class="p">,</span> <span class="s1">&#39;middleware&#39;</span><span class="p">],</span> <span class="nx">arguments</span><span class="p">);</span>

    <span class="nx">factor</span><span class="p">(</span><span class="nx">stage</span><span class="p">,</span> <span class="nx">options</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">definition</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">verbs</span> <span class="o">=</span> <span class="nx">definition</span><span class="p">.</span><span class="nx">verbs</span> <span class="o">||</span> <span class="s1">&#39;head get post put del&#39;</span><span class="p">;</span>

      <span class="nx">verbs</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">verb</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">verb</span><span class="p">)</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

        <span class="kd">var</span> <span class="nx">path</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">definition</span><span class="p">.</span><span class="nx">howMany</span> <span class="o">===</span> <span class="s1">&#39;instance&#39;</span><span class="p">)</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;basePathWithId&#39;</span><span class="p">);</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">definition</span><span class="p">.</span><span class="nx">howMany</span> <span class="o">===</span> <span class="s1">&#39;collection&#39;</span><span class="p">)</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;basePath&#39;</span><span class="p">);</span>
        <span class="k">else</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Unrecognized howMany.&#39;</span><span class="p">);</span>

        <span class="nx">controller</span><span class="p">[</span><span class="nx">verb</span><span class="p">](</span><span class="nx">path</span><span class="p">,</span> <span class="nx">definition</span><span class="p">.</span><span class="nx">middleware</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p><strong>Public Instance Methods</strong></p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>A method used to register request-stage middleware.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">controller</span><span class="p">.</span><span class="nx">request</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">howMany</span><span class="p">,</span> <span class="nx">verbs</span><span class="p">,</span> <span class="nx">middleware</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">register</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">,</span> <span class="nx">howMany</span><span class="p">,</span> <span class="nx">verbs</span><span class="p">,</span> <span class="nx">middleware</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">controller</span><span class="p">;</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>A method used to register query-stage middleware.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">controller</span><span class="p">.</span><span class="nx">query</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">howMany</span><span class="p">,</span> <span class="nx">verbs</span><span class="p">,</span> <span class="nx">middleware</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">register</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="nx">howMany</span><span class="p">,</span> <span class="nx">verbs</span><span class="p">,</span> <span class="nx">middleware</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">controller</span><span class="p">;</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>A method used to register document-stage middleware.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">controller</span><span class="p">.</span><span class="nx">documents</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">howMany</span><span class="p">,</span> <span class="nx">verbs</span><span class="p">,</span> <span class="nx">middleware</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">register</span><span class="p">(</span><span class="s1">&#39;documents&#39;</span><span class="p">,</span> <span class="nx">howMany</span><span class="p">,</span> <span class="nx">verbs</span><span class="p">,</span> <span class="nx">middleware</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">controller</span><span class="p">;</span>
  <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>A method used to intialize the controller and activate user middleware.  It
may be called multiple times, but will trigger intialization only once.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">controller</span><span class="p">.</span><span class="nx">activate</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">activated</span><span class="p">)</span> <span class="k">return</span> <span class="nx">controller</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p><strong>Request-Stage Middleware</strong></p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Activate middleware that sets the Allow &amp; Accept headers</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">activate</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="nx">middleware</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">allow</span><span class="p">,</span> <span class="nx">middleware</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">accept</span> <span class="p">]);</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Activate middleware to set request.baucis.conditions for find/remove</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">activate</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">,</span> <span class="s1">&#39;collection&#39;</span><span class="p">,</span> <span class="s1">&#39;head get del&#39;</span><span class="p">,</span> <span class="nx">middleware</span><span class="p">.</span><span class="nx">configure</span><span class="p">.</span><span class="nx">conditions</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Next, activate the request-stage user middleware.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">activate</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">,</span> <span class="nx">custom</span><span class="p">[</span><span class="s1">&#39;request&#39;</span><span class="p">]);</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Activate middleware to build the query (except for POST requests).</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">activate</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">,</span> <span class="nx">middleware</span><span class="p">.</span><span class="nx">query</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p><strong>Query-Stage Middleware</strong>
The query will have been created (except for POST, which doesn't use a
find or remove query).</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Activate middleware to handle controller and query options.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">activate</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="nx">middleware</span><span class="p">.</span><span class="nx">configure</span><span class="p">.</span><span class="nx">controller</span><span class="p">,</span> <span class="nx">middleware</span><span class="p">.</span><span class="nx">configure</span><span class="p">.</span><span class="nx">query</span> <span class="p">]);</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Delete any query-stage POST middleware that was added implicitly.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">custom</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">instance</span><span class="p">.</span><span class="nx">post</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">custom</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">put</span> <span class="o">=</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Activate user middleware for the query-stage</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">activate</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="nx">custom</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">]);</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Activate middleware to execute the query:</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Get the count for HEAD requests.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">activate</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">,</span> <span class="nx">middleware</span><span class="p">.</span><span class="nx">exec</span><span class="p">.</span><span class="nx">count</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Execute the find or remove query for GET and DELETE.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">activate</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="s1">&#39;get del&#39;</span><span class="p">,</span> <span class="nx">middleware</span><span class="p">.</span><span class="nx">exec</span><span class="p">.</span><span class="nx">exec</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Create the documents for a POST request.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">activate</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="s1">&#39;collection&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="nx">middleware</span><span class="p">.</span><span class="nx">exec</span><span class="p">.</span><span class="nx">create</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Update the documents specified for a PUT request.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">activate</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="s1">&#39;instance&#39;</span><span class="p">,</span> <span class="s1">&#39;put&#39;</span><span class="p">,</span> <span class="nx">middleware</span><span class="p">.</span><span class="nx">exec</span><span class="p">.</span><span class="nx">update</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Activate some middleware that will set the Link header when that feature
is enabled.  (This must come after exec or else the count is
returned for all subsequqent executions of the query.)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;relations&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">activate</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="s1">&#39;instance&#39;</span><span class="p">,</span> <span class="s1">&#39;head get post put del&#39;</span><span class="p">,</span> <span class="nx">middleware</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">link</span><span class="p">);</span>
      <span class="nx">activate</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="s1">&#39;collection&#39;</span><span class="p">,</span> <span class="s1">&#39;head get post put del&#39;</span><span class="p">,</span> <span class="nx">middleware</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">linkCollection</span><span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p><strong>Document-Stage Middleware</strong></p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Activate the middleware that sets the <code>Last-Modified</code> header when appropriate.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">activate</span><span class="p">(</span><span class="s1">&#39;documents&#39;</span><span class="p">,</span> <span class="nx">middleware</span><span class="p">.</span><span class="nx">documents</span><span class="p">.</span><span class="nx">lastModified</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Activate the the document-stage user middleware.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">activate</span><span class="p">(</span><span class="s1">&#39;documents&#39;</span><span class="p">,</span> <span class="nx">custom</span><span class="p">[</span><span class="s1">&#39;documents&#39;</span><span class="p">]);</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Activate the middleware that sends the resulting document(s) or count.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">activate</span><span class="p">(</span><span class="s1">&#39;documents&#39;</span><span class="p">,</span> <span class="nx">middleware</span><span class="p">.</span><span class="nx">documents</span><span class="p">.</span><span class="nx">send</span><span class="p">);</span>

    <span class="k">delete</span> <span class="nx">custom</span><span class="p">;</span>
    <span class="nx">activated</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">controller</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">};</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 