var internal={init:function(){function e(e){TukTuk.Modal.hide(),$("#modal_text").html(e+"<br/>"),TukTuk.Modal.show("modal")}console.info("Init internal code");var a,t=[];$.get("/message/users/",function(e){localStorage.setItem("users",JSON.stringify(e)),t=e,a=new Sifter(e)},"json").fail(function(){var e=localStorage.getItem("users");e?(t=JSON.parse(e),a=new Sifter(t)):a=new Sifter([])}),$("#message_receiver").on("keyup",function(){if(0==$(this).val().length)return $("#message_results").html(""),void 0;var e=a.search($(this).val(),{fields:["firstname","lastname"],sort:"title",direction:"desc",limit:3}),s=e.items,n="<ul>";return _.each(s,function(e){var a=t[e.id];n+='<li style="display: block;overflow: hidden; user-select: none; padding: 2px; vertical-align: middle;"><span style="vertical-align: middle;">'+a.firstname+" "+a.lastname+'</span><a href="#" data-id="'+a._id+'" data-name="'+a.firstname+" "+a.lastname+'"  class="button tiny icon plus on-right message_add_user"></a></li>'}),n+="</ul>",$("#message_results").html(n),!1}),$("#message_results").off("click").on("click",".message_add_user",function(){return 0==$("#message_users [data-id='"+$(this).attr("data-id")+"']").length&&$("#message_users").append('<div class="on-left margin-right margin-bottom" style="cursor: pointer; user-select: none; -webkit-user-select: none;" data-id="'+$(this).attr("data-id")+'"><span class="icon small user"></span><span> '+$(this).attr("data-name")+"</span></div>"),!1}),$("#message_users").off("dblclick").on("dblclick","div",function(){return $(this).remove(),!1}),$(".message_to_user").on("click",function(){$("#message_users").empty(),$("#message_users").append('<div class="on-left margin-right margin-bottom" style="cursor: pointer; user-select: none; -webkit-user-select: none;" data-id="'+$(this).attr("data-id")+'"><span class="icon small user"></span><span> '+$(this).attr("data-name")+"</span></div>")}),$("#send_message").on("click",function(){var e=$("#message_name").val(),a=$("#message_text").val();if(""==e)return $("#message_name").attr("required","required"),void 0;if($("#message_name").removeAttr("required"),""==a)return $("#message_text").attr("required","required"),void 0;$("#message_text").removeAttr("required"),0==$("#message_users").children().length&&$("#message_receiver").attr("required","required");var t=[];return $("#message_users").children().each(function(){t.push($(this).attr("data-id"))}),$.post("/message/send",{name:e,text:a,receiver:t},function(e){TukTuk.Modal.hide(),e.response&&location.reload(!0)},"json"),!1}),$("#updateprofile").on("click",function(){TukTuk.Modal.loading();var a=$("#firstname").val(),t=$("#lastname").val(),s=$("#borndate").val(),n=$("#avatar").val();return""==a?(e("El nombre no puede quedar vacío."),void 0):""==t?(e("El apellido no puede quedar vacío."),void 0):($.post("/update_profile",{firstname:a,lastname:t,borndate:s,avatar:n},function(){TukTuk.Modal.hide(),location.reload(!0)},"json"),!1)}),$("#change_picture").on("click",function(){return Dropbox.choose({success:function(e){$("#change_picture").attr("src",e[0].thumbnails["200x200"]),$('[name="avatar"]').val(e[0].thumbnails["200x200"])},cancel:function(){},linkType:"preview",multiselect:!1,extensions:[".jpg",".png"]}),!1}),document.getElementById("borndate").valueAsDate=new Date("{{ user.born_date|date('m/d/Y') }}")}},app={messages:function(){$(".show-message").on("click",function(){return $("#show_message_name").text($(this).attr("data-name")),$("#show_message_text").html($(this).attr("data-text").replace(/\n/g,"<br/>")),$("#show_message_read").attr("data-id",$(this).attr("data-id")),$("#show_message_read").attr("checked",$("#icon_"+$(this).attr("data-id")).hasClass("ok")),"sent"==$(this).attr("data-type")&&($("#show_message_reads").empty(),$("#show_message_noreads").empty(),$.post("/message/box/read",{id:$(this).attr("data-id")},function(e){for(var a in e.read)$("#show_message_reads").append('<div class="on-left margin-right margin-bottom" style="cursor: pointer; user-select: none; -webkit-user-select: none;"><span class="icon small user"></span><span> '+e.read[a].firstname+" "+e.read[a].lastname+"</span></div>");for(var a in e.no_read)$("#show_message_noreads").append('<div class="on-left margin-right margin-bottom" style="cursor: pointer; user-select: none; -webkit-user-select: none;"><span class="icon small user"></span><span> '+e.no_read[a].firstname+" "+e.no_read[a].lastname+"</span></div>")},"json")),!1}),$("#show_message_read").on("click",function(){var e=$("#show_message_read").attr("data-id"),a=$("#show_message_read").val();return $.post("/message/mark",{id:e,read:a},function(t){t.response===!0&&("on"==a?($("#icon_"+e).removeClass("asterisk"),$("#icon_"+e).addClass("ok")):($("#icon_"+e).removeClass("ok"),$("#icon_"+e).addClass("asterisk")))},"json"),!1})},grade:function(){var e=0;$("#social_attach").on("click",function(){return Dropbox.choose({success:function(a){for(var t in a)$("#social_attachments").append('<div id="attach_'+e+'" ondblclick="remove(\'attach_'+e+'\');" style="width: 50%; float: left; margin-bottom: 10px; text-align: center;" data-icon="'+a[t].icon+'" data-link="'+a[t].link+'" data-name="'+a[t].name+'" class="radius light center"><img src="'+a[t].icon+'" /><p><small>'+a[t].name+"</small></p></div>"),e++},cancel:function(){},linkType:"preview",multiselect:!0}),!1}),$("#sendsocialbtn").on("click",function(){var e=$("#social_name").val(),a=$("#social_text").val(),t=$("#social_grade").val();if(""==e)return $("#social_name").attr("required","required"),void 0;if($("#social_name").removeAttr("required"),""==a)return $("#social_text").attr("required","required"),void 0;var s=[];return $("#social_attachments").children().each(function(){s.push({icon:$(this).attr("data-icon"),link:$(this).attr("data-link"),name:$(this).attr("data-name")})}),$.post("/add_social_stream",{name:e,text:a,grade:t,attachments:s},function(){TukTuk.Modal.hide(),location.reload(!0)},"json"),!1})},social:function(){$("#sendsocialbtn").on("click",function(){TukTuk.Modal.loading();var e=$("#social_name").val(),a=$("#social_text").val();return""==e?(modalAlert("El título no puede quedar vacío."),void 0):""==a?(modalAlert("El texto no puede ser vacío."),void 0):($.post("/add_social_stream",{name:e,text:a},function(){TukTuk.Modal.hide(),location.reload(!0)},"json"),!1)})},login:function(){$("#loginbtn").on("click",function(){return $.post("/login",{username:$("#username").val(),password:$("#password").val()},function(e){e.response?location.href="/dashboard":alert("Wrong username or password")},"json"),!1})}};